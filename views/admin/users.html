<div class="space-y-6">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Manage Admin Users</h1>
        <button onclick="openCreateModal()" 
                class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
            Create User
        </button>
    </div>
    
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Admin Users</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created At</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTable" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="userModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 id="modalTitle" class="text-lg font-medium text-gray-900 mb-4">Create Admin User</h3>
            <form id="userForm">
                <input type="hidden" id="userId" name="id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username *</label>
                    <input type="text" id="usernameInput" name="username" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        Password <span id="passwordRequired">*</span>
                        <span id="passwordOptional" class="text-gray-500 text-xs">(leave blank to keep current)</span>
                    </label>
                    <input type="password" id="passwordInput" name="password"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" 
                            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentEditId = null;

async function loadUsers() {
    const response = await fetch('/api/v1/admin/users');
    const result = await response.json();
    
    const tbody = document.getElementById('usersTable');
    if (result.data && result.data.length > 0) {
        tbody.innerHTML = result.data.map(user => {
            const createdDate = new Date(user.created_at).toLocaleDateString();
            return `
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.id}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.username}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${createdDate}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <button onclick="editUser(${user.id})" class="text-indigo-600 hover:text-indigo-900 mr-3">Edit</button>
                    <button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">Delete</button>
                </td>
            </tr>
        `;
        }).join('');
    } else {
        tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">No users found</td></tr>';
    }
}

function openCreateModal() {
    currentEditId = null;
    document.getElementById('modalTitle').textContent = 'Create Admin User';
    document.getElementById('userForm').reset();
    document.getElementById('passwordRequired').style.display = 'inline';
    document.getElementById('passwordOptional').style.display = 'none';
    document.getElementById('passwordInput').required = true;
    document.getElementById('userModal').classList.remove('hidden');
}

function editUser(id) {
    currentEditId = id;
    document.getElementById('modalTitle').textContent = 'Edit Admin User';
    
    fetch(`/api/v1/admin/users`)
        .then(r => r.json())
        .then(result => {
            const user = result.data.find(u => u.id === id);
            if (user) {
                document.getElementById('userId').value = user.id;
                document.getElementById('usernameInput').value = user.username;
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('passwordOptional').style.display = 'inline';
                document.getElementById('passwordInput').required = false;
                document.getElementById('passwordInput').value = '';
            }
        });
    
    document.getElementById('userModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('userModal').classList.add('hidden');
    currentEditId = null;
}

async function deleteUser(id) {
    if (!confirm('Are you sure you want to delete this user?')) return;
    
    const response = await fetch(`/api/v1/admin/users/${id}`, { method: 'DELETE' });
    const result = await response.json();
    
    if (result.success) {
        loadUsers();
    } else {
        alert(result.error || 'Failed to delete user');
    }
}

document.getElementById('userForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Remove empty password for updates
    if (currentEditId && !data.password) {
        delete data.password;
    }
    
    // Remove id from data (it's in URL)
    delete data.id;
    
    const url = currentEditId 
        ? `/api/v1/admin/users/${currentEditId}`
        : '/api/v1/admin/users';
    const method = currentEditId ? 'PUT' : 'POST';
    
    const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    const result = await response.json();
    if (result.success) {
        closeModal();
        loadUsers();
    } else {
        alert(result.error || 'Failed to save user');
    }
});

loadUsers();
</script>
